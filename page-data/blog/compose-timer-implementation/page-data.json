{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/blog/compose-timer-implementation",
    "result": {"data":{"site":{"siteMetadata":{"title":"Anton Danshin"}},"markdownRemark":{"id":"0f69fca0-7040-5cbd-94d3-8cdce7c0d88f","excerpt":"In my app I need to display some sort of timers and clocks in several places, so I thought it would be nice to make a stateful component for it. I looked online…","html":"<p>In my app I need to display some sort of timers and clocks in several places, so I thought it would be nice to make a stateful component for it. I looked online and found several good and bad implementations of it. So I decided to share my views and how I would go about this problem.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/3acf0/countdown-timer.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAgX/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/aAAwDAQACEAMQAAABfJ3Fl0Gij//EABwQAAAGAwAAAAAAAAAAAAAAAAABAgQRMQMSE//aAAgBAQABBQJyebrLkInVdgq//8QAFREBAQAAAAAAAAAAAAAAAAAAEBL/2gAIAQMBAT8Bo//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAIBBQAAAAAAAAAAAAAAAAARASAiMUJh/9oACAEBAAY/ArGuGxDzR//EABoQAAIDAQEAAAAAAAAAAAAAAAABETFRcSH/2gAIAQEAAT8hVy/JE2eM4cpLBFB//9oADAMBAAIAAwAAABD/AP8A/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAERITH/2gAIAQMBAT8QUZB9P//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/EIf/xAAbEAACAwEBAQAAAAAAAAAAAAABEQAhMaFhwf/aAAgBAQABPxAic0ogNW7lQEWaU/ZrQbT1XOKbnAJ//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Countdown timer\"\n        title=\"Countdown timer\"\n        src=\"/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/828fb/countdown-timer.jpg\"\n        srcset=\"/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/ff44c/countdown-timer.jpg 158w,\n/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/a6688/countdown-timer.jpg 315w,\n/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/828fb/countdown-timer.jpg 630w,\n/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/0ede0/countdown-timer.jpg 945w,\n/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/3ac88/countdown-timer.jpg 1260w,\n/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/3acf0/countdown-timer.jpg 2000w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><small> — Design vector created by pikisuperstar <a href=\"https://www.freepik.com/vectors/design\">www.freepik.com</a></small></p>\n<h2>The problem</h2>\n<p>Let’s set our goal first. We want to implement a component that allows you to display a countdown timer.</p>\n<ul>\n<li>There shouldn’t be any assumption on how it will be displayed: it can be a <code class=\"language-text\">Text()</code>, <code class=\"language-text\">Canvas()</code> or anything.</li>\n<li>The first displayed state should be initial state</li>\n<li>The last displayed state must be 0 (never negative).</li>\n</ul>\n<h2>Simple solution – Naive approach</h2>\n<p>To achieve that, we can create a <code class=\"language-text\">MutableState&lt;Long></code> that would update itself in a <code class=\"language-text\">LaunchedEffect</code>. The users will just need to render it and the UI will automatically be updated on change.</p>\n<p>Here is how it can be used:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber 0\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">MyTimer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> timeLeftMs <span class=\"token keyword\">by</span> <span class=\"token function\">rememberCountdownTimerState</span><span class=\"token punctuation\">(</span><span class=\"token number\">5_000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation variable\">$timeLeftMs</span> ms left\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>A simple implementation would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber 0\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">rememberCountdownTimerState</span><span class=\"token punctuation\">(</span>\n    initialMillis<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span>\n    step<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MutableState<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> timeLeft <span class=\"token operator\">=</span> remember <span class=\"token punctuation\">{</span><span class=\"token function\">mutableStateOf</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token function\">LaunchedEffect</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>isActive <span class=\"token operator\">&amp;&amp;</span> timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">-</span> step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> timeLeft\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>It will work, but it has several obvious problems:</p>\n<ul>\n<li>The last delay could be longer than actually needed, so <code class=\"language-text\">0</code> state will be rendered with up to 99 ms delay.</li>\n<li>There is not account of time that took to execute <code class=\"language-text\">onTick()</code>, and there is no guarantee that <code class=\"language-text\">delay(n)</code> will return resume after exactly <code class=\"language-text\">n</code> ms.</li>\n</ul>\n<p>The first problem can be quickly fixed by making sure we never <code class=\"language-text\">delay</code> by more than <code class=\"language-text\">timeLeft</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber 0\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">rememberCountdownTimerState</span><span class=\"token punctuation\">(</span>\n    initialMillis<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span>\n    step<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MutableState<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> timeLeft <span class=\"token operator\">=</span> remember <span class=\"token punctuation\">{</span> <span class=\"token function\">mutableStateOf</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">LaunchedEffect</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>isActive <span class=\"token operator\">&amp;&amp;</span> timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">-</span> step<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtMost</span><span class=\"token punctuation\">(</span>timeLeft<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> timeLeft\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>To fix second problem we need to use system clock.</p>\n<h2>Better solution – Using SystemClock</h2>\n<p>Instead of <code class=\"language-text\">System.currentTimeMillis()</code> available in Java, for this particular task it is recommented to use some monotonic time source, such as Android <code class=\"language-text\">SystemClock.uptimeMillis()</code>.</p>\n<p>The idea is to remember when we started our timer in <code class=\"language-text\">startTime</code> and on each cycle of the loop check how much time has actually passed (<code class=\"language-text\">duration</code>).</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber 0\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">rememberCountdownTimerState</span><span class=\"token punctuation\">(</span>\n    initialMillis<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span>\n    step<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MutableState<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> timeLeft <span class=\"token operator\">=</span> remember <span class=\"token punctuation\">{</span> <span class=\"token function\">mutableStateOf</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">LaunchedEffect</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> startTime <span class=\"token operator\">=</span> SystemClock<span class=\"token punctuation\">.</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>isActive <span class=\"token operator\">&amp;&amp;</span> timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// how much time actually passed</span>\n            <span class=\"token keyword\">val</span> duration <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>SystemClock<span class=\"token punctuation\">.</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>initialMillis <span class=\"token operator\">-</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtMost</span><span class=\"token punctuation\">(</span>timeLeft<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> timeLeft\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The solution solution works perfectly fine, but if we were to publish it as a library and let other people use it, we would probably want to add some tests to it (e.g. screenshot tests). To make it testable we can pass a lambda as our time source, which would default to <code class=\"language-text\">SystemClock.uptimeMillis()</code>.</p>\n<h2>Alternative solution – Using withFrameMillis</h2>\n<p>If we dig into how animated components are tested, we can find that compose has its own built-in monotonic time source – <code class=\"language-text\">MonotonicFrameClock</code>. It is an abstraction over Choreographer, if we provide another implementation in unit-tests, it will allow to control time there.</p>\n<p>Here is how we can rewrite our component to use this <code class=\"language-text\">withFrameMillis()</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre style=\"counter-reset: linenumber 0\" class=\"language-kotlin line-numbers\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Composable</span>\n<span class=\"token annotation builtin\">@OptIn</span><span class=\"token punctuation\">(</span>ExperimentalComposeApi<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">rememberCountdownTimerState</span><span class=\"token punctuation\">(</span>\n    initialMillis<span class=\"token operator\">:</span> Long<span class=\"token punctuation\">,</span>\n    step<span class=\"token operator\">:</span> Long <span class=\"token operator\">=</span> <span class=\"token number\">1000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MutableState<span class=\"token operator\">&lt;</span>Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> timeLeft <span class=\"token operator\">=</span> remember <span class=\"token punctuation\">{</span> <span class=\"token function\">mutableStateOf</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">LaunchedEffect</span><span class=\"token punctuation\">(</span>initialMillis<span class=\"token punctuation\">,</span> step<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> startTime <span class=\"token operator\">=</span> withFrameMillis <span class=\"token punctuation\">{</span> it <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>isActive <span class=\"token operator\">&amp;&amp;</span> timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> duration <span class=\"token operator\">=</span> withFrameMillis <span class=\"token punctuation\">{</span> time <span class=\"token operator\">-></span>\n                <span class=\"token punctuation\">(</span>time <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n            timeLeft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>initialMillis <span class=\"token operator\">-</span> duration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">.</span><span class=\"token function\">coerceAtMost</span><span class=\"token punctuation\">(</span>timeLeft<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> timeLeft\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The advantage of this implementation is that it can be tested using <code class=\"language-text\">ComposeTestRule</code> just like other components with animations.\nHovever, I also see several issues with this approach:</p>\n<ul>\n<li>The timer is tied to the display refresh rate, which means no mater how small we set the step, the loop will suspend on each frame (this could be a good thing). However, for that reason, the timer will probably be less presize.</li>\n<li>It probably introduces more overhead due to abstractions and callback (compared to system call to <code class=\"language-text\">SystemClock.uptimeMillis()</code>).</li>\n</ul>\n<p>It would probably be an overkill to write a timer this way, but inspite of all this, I still had a lot of fun digging into it.</p>\n<h2>Conclusion</h2>\n<p>We’ve looked into several implementations of a countdown timer in Jetpack Compose. I am sure there are more and we just scratched the surface. I would personally use the approach with <code class=\"language-text\">SystemClock.uptimeMillis()</code>, but I think that <code class=\"language-text\">withFrameMillis()</code> isn’t such a bad idea either. Let me know what you think. :)</p>","fields":{"slug":"/compose-timer-implementation","readingTime":{"text":"5 min read"}},"frontmatter":{"title":"Countdown timer with Jetpack Compose","date":"September 28, 2021","updated":"September 29, 2021","description":"Different approaches to implementing timer with Jetpack Compose.","draft":false}},"previous":{"fields":{"slug":"/updating-to-android-gradle-plugin-7"},"frontmatter":{"title":"Upgraded my project to Android gradle plugin 7"}},"next":{"fields":{"slug":"/compose-user-avatar-placeholder"},"frontmatter":{"title":"Material avatar placeholder in Jetpack Compose"}}},"pageContext":{"id":"0f69fca0-7040-5cbd-94d3-8cdce7c0d88f","previousPostId":"3d4de3dc-9dc4-5a81-a6fb-f33428fd18ab","nextPostId":"8551b0a9-b199-5c6d-a06b-3f9f0a3b45bb"}},
    "staticQueryHashes": ["2841359383","3274528899"]}