{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/updating-to-android-gradle-plugin-7/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Anton Danshin's Blog"}},"markdownRemark":{"id":"3d4de3dc-9dc4-5a81-a6fb-f33428fd18ab","excerpt":"It has never been like this and now it is exactly the same again. — Viktor Chernomyrdin I’ve spent several last week’s nights to get one of my project’s CI…","html":"<blockquote>\n<p><strong>It has never been like this and now it is exactly the same again.</strong> — Viktor Chernomyrdin</p>\n</blockquote>\n<p>I’ve spent several last week’s nights to get one of my project’s CI pipeline back up on its feet after upgrading to latest Android gradle plugin (7.0.2). I usually try too keep versions up-to-date, but got distracted with other projects. As a result, the app was not updated for the last 4 months – just when Google suddenly released a bunch of updates to Android’s build tools, which broke everything…</p>\n<h2>Breaking changes in Gradle 7.x</h2>\n<p>Android Gradle Plugin now has the same major version number with Gradle, so its version jumped from 4.x to 7.0. This is a good thing, as there will be less confusion with the versions. In addition to breaking changes to the plugin APIs, which forced me to update several other third-party gradle plugins (e.g. Sentry), Android Gradle Plugin adds some requirements to the environment.</p>\n<h2>Updating to JDK 11</h2>\n<p>Previously, everything would compile with Java 8. Now Android Gradle Plugin requires JDK 11.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">An exception occurred applying plugin request [id: 'com.android.application']\n> Failed to apply plugin 'com.android.internal.application'.\n   > Android Gradle plugin requires Java 11 to run. You are currently using Java 1.8.\n     You can try some of the following options:\n       - changing the IDE settings.\n       - changing the JAVA_HOME environment variable.\n       - changing `org.gradle.java.home` in `gradle.properties`.</code></pre></div>\n<p>It can be installed with <code class=\"language-text\">Homebrew</code> with the following command: <code class=\"language-text\">brew install --cask adoptopenjdk11</code>. There is also a nice article on how enable quick <a href=\"https://mkyong.com/java/how-to-set-java_home-environment-variable-on-mac-os-x/#switch-between-different-jdk-versions\">switching between JDK versions</a>.</p>\n<p>I thought this was it, I moved on with the feature development. However, when I was ready to present an early prototype to my teammates for testing, I found out that Jenkins (our CI server) was unable to build the app. All because CI was trying to build it with JDK 8. Luckily the we run our Android builds inside a docker container. And I thought to myself:</p>\n<blockquote>\n<p>This where docker will show it’s power!</p>\n<p>All I need to do is to replace package <code class=\"language-text\">openjdk-8-jdk</code> with <code class=\"language-text\">openjdk-11-jdk</code> in my Dockerfile, and everything should work, just like on my local machine.</p>\n</blockquote>\n<p>Build failed again when SDK Manager was trying to install some packages, required for building Android apps.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Step 13/18 : RUN yes | sdkmanager --licenses\nException in thread \"main\" \u001bjava.lang.NoClassDefFoundError: javax/xml/bind/annotation/XmlSchema\n\u001b   at com.android.repository.api.SchemaModule$SchemaModuleVersion.&lt;init>(SchemaModule.java:156)\n\u001b   at com.android.repository.api.SchemaModule.&lt;init>(SchemaModule.java:75)\n    at com.android.sdklib.repository.AndroidSdkHandler.&lt;clinit>(AndroidSdkHandler.java:81)\n    at com.android.sdklib.tool.sdkmanager.SdkManagerCli.main(SdkManagerCli.java:73)\n    at com.android.sdklib.tool.sdkmanager.SdkManagerCli.main(SdkManagerCli.java:48)\nCaused by: java.lang.ClassNotFoundException: javax.xml.bind.annotation.XmlSchema\n    at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:581)\n\u001b   at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:178)\n    at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:522)\n    ... 5 more\n\u001bThe command '/bin/sh -c yes | sdkmanager --licenses' returned a non-zero code: 1</code></pre></div>\n<p>It looks like when I put together this build script more than a year ago, I probably used some outdated sources of information. It used <a href=\"https://developer.android.com/studio/releases/sdk-tools\">deprecated SDK tools</a>, which apparently doesn’t work with Java 11. I’ve spent quite some time trying to get it to work before I realized that this was the dead end and I have to move on to the new Android <a href=\"https://developer.android.com/studio#cmdline-tools\">command-line tools</a>.</p>\n<p>My new Dockerfile with Android build environment for CI now looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> ubuntu:18.04</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> LANG=<span class=\"token string\">'C'</span> LANGUAGE=<span class=\"token string\">'en'</span> LC_ALL=<span class=\"token string\">'C'</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> DEBIAN_FRONTEND=noninteractive</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> GRADLE_HOME=/usr/bin/gradle</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> ANDROID_SDK_ROOT=/opt/android-sdk</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class=\"token operator\">\\</span>\n        --allow-downgrades --allow-remove-essential --allow-change-held-packages <span class=\"token operator\">\\</span>\n        expect <span class=\"token operator\">\\</span>\n        git <span class=\"token operator\">\\</span>\n        mc <span class=\"token operator\">\\</span>\n        gradle <span class=\"token operator\">\\</span>\n        unzip <span class=\"token operator\">\\</span>\n        wget curl <span class=\"token operator\">\\</span>\n        libc6-i386 lib32stdc++6 lib32gcc1 lib32ncurses5 lib32z1 <span class=\"token operator\">\\</span>\n        openjdk-11-jdk <span class=\"token operator\">\\</span>\n    &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> rm -f /etc/ssl/certs/java/cacerts; <span class=\"token operator\">\\</span>\n    /var/lib/dpkg/info/ca-certificates-java.postinst configure</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH <span class=\"token variable\">$PATH</span>:/opt/tools</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> cd /opt <span class=\"token operator\">\\</span>\n    &amp;&amp; wget --output-document=android-commandline-tools.zip <span class=\"token operator\">\\</span>\n        https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip <span class=\"token operator\">\\</span>\n    &amp;&amp; mkdir -p <span class=\"token variable\">${ANDROID_SDK_ROOT}</span>/cmdline-tools <span class=\"token operator\">\\</span>\n    &amp;&amp; unzip android-commandline-tools.zip -d <span class=\"token variable\">${ANDROID_SDK_ROOT}</span>/cmdline-tools <span class=\"token operator\">\\</span>\n    &amp;&amp; mv <span class=\"token variable\">${ANDROID_SDK_ROOT}</span>/cmdline-tools/cmdline-tools <span class=\"token variable\">${ANDROID_SDK_ROOT}</span>/cmdline-tools/latest <span class=\"token operator\">\\</span>\n    &amp;&amp; rm -v android-commandline-tools.zip <span class=\"token operator\">\\</span>\n    &amp;&amp; chown -R root.root /opt/android-sdk</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> ANDROID_HOME <span class=\"token string\">\"${ANDROID_SDK_ROOT}\"</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> JAVA_HOME  /usr/lib/jvm/java-11-openjdk-amd64</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH <span class=\"token variable\">$PATH</span>:<span class=\"token variable\">$JAVA_HOME</span>/bin:<span class=\"token variable\">$ANDROID_HOME</span>/cmdline-tools/latest/bin</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yes | sdkmanager --licenses</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sdkmanager --update</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ADD</span> packages.txt <span class=\"token variable\">$ANDROID_SDK_ROOT</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> yes | sdkmanager --package_file=<span class=\"token variable\">$ANDROID_SDK_ROOT</span>/packages.txt</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH <span class=\"token variable\">$PATH</span>:<span class=\"token variable\">$ANDROID_HOME</span>/tools:<span class=\"token variable\">$ANDROID_HOME</span>/tools/bin:<span class=\"token variable\">$ANDROID_HOME</span>/platform-tools</span></code></pre></div>\n<h2>Broken release build</h2>\n<p>I finally had an environment on my CI that can build my app. But when it tried to make a release apk, it failed again.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/07db1087d81e271fbdf20d5a7de3b3f8/1cb21/broken-ci-build.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.810126582278485%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABdElEQVQozyWPiarbMBBF/f9f9iAQKG2TZvMuW5JlW5YUL2meT4k6MMxwN2aS7/ebfd/51LZtCCHwweO95/l8Yu0Y8XVdcd7FfZ5nxnHEOUfwHmstIQRC8CSfoO99573vzPNCnuX0pke2CtMZ6qomuMBkHUpqJjsxmIG2aVFdhzYG0bRR2+mOZCpyrGxZjcGNHWKsUU7Szx1qammGGhM07SRJZR45OUkaU+HqCptnjFlK7xT905CMf06Y+4WtLJh0SREymrlCbgIxl5Q+Q21NxNL+FqdYKqrxwfL7B8vxQDge0K5AbZKkPZ9oLifs/Yqqblz0ORqLKeVhrlzVmdw+SPs75+YX2XAnHe7c2hP255Hx8EV3+KLUF0pXkEgz0JuO17LhFxsvkrNAvyTtXFP5Ar21yEWQD4/IffDa5WhboMaMxjxQi6BbFUnTjdjJ8nq98aujCjlyaTBv9d8Yihiu1obqE7K1sT+vm7dGvSRiqaO+/9vxDzBYDOI4Xk9JAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Broken release apk build on CI\"\n        title=\"Broken release apk build on CI\"\n        src=\"/static/07db1087d81e271fbdf20d5a7de3b3f8/f058b/broken-ci-build.png\"\n        srcset=\"/static/07db1087d81e271fbdf20d5a7de3b3f8/c26ae/broken-ci-build.png 158w,\n/static/07db1087d81e271fbdf20d5a7de3b3f8/6bdcf/broken-ci-build.png 315w,\n/static/07db1087d81e271fbdf20d5a7de3b3f8/f058b/broken-ci-build.png 630w,\n/static/07db1087d81e271fbdf20d5a7de3b3f8/40601/broken-ci-build.png 945w,\n/static/07db1087d81e271fbdf20d5a7de3b3f8/78612/broken-ci-build.png 1260w,\n/static/07db1087d81e271fbdf20d5a7de3b3f8/1cb21/broken-ci-build.png 2586w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">> Task :app:addSentryProguardSettingsForRelease FAILED\n\nFAILURE: Build failed with an exception.\n\n* What went wrong:\nA problem was found with the configuration of task ':app:addSentryProguardSettingsForRelease' (type 'SentryProguardConfigTask').\n  - Type 'io.sentry.android.gradle.SentryProguardConfigTask' property 'applicationVariant' is missing an input or output annotation.\n\n    Reason: A property without annotation isn't considered during up-to-date checking.\n\n    Possible solutions:\n      1. Add an input or output annotation.\n      2. Mark it as @Internal.</code></pre></div>\n<p>Apparentrly, during last few months technologies made a big step forward. Gradle has removed some deprecated plugin API, used by older version of Sentry plugin. And the error only showed itself during release compilation.</p>\n<p>Sentry released updates, so updating <code class=\"language-text\">sentry-android-gradle-plugin</code> from 1.7.36 to latest 2.1.4 solves the problems. I was also surprized that they bumped their SDK major version twice (from 3.2.0 to 5.2.0).</p>\n<h2>Fixing R8 full mode</h2>\n<p>After updating CI environment, I finally was able to build a proper release APK. However, when I run it, the app just crashed.</p>\n<p>Turns out there was a problem with R8, which appeared after update. Deobfuscated stacktrace looked like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Caused by java.lang.ClassCastException: java.lang.Class cannot be cast to java.lang.reflect.ParameterizedType\n    at retrofit2.HttpServiceMethod.parseAnnotations(HttpServiceMethod.java:46)\n    at retrofit2.ServiceMethod.parseAnnotations(ServiceMethod.java:39)\n    at retrofit2.Retrofit.loadServiceMethod(Retrofit.java:202)\n    at retrofit2.Retrofit.validateServiceInterface(Retrofit.java:189)\n    at retrofit2.Retrofit.create(Retrofit.java:141)\n    ...</code></pre></div>\n<p>The issue is not reproduced with <code class=\"language-text\">android.enableR8.fullMode=false</code>.</p>\n<p>I almost decided to diable R8 full mode but suddenly I found a question with <a href=\"https://stackoverflow.com/q/69098376/1199452\">similar problem</a> on StackOverflow. The answer contains a bunch of ProGuard rules that work, but actually redundant.</p>\n<p>It looks like in R8 full mode, in <code class=\"language-text\">suspend</code> methods of Retrofit service interface, generic type of implicit parameter <code class=\"language-text\">kotlin.coroutines.Continuation</code> gets erased. That’s why adding just this line ProGuard rules solves the above error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">-keep,allowobfuscation,allowshrinking class kotlin.coroutines.Continuation</code></pre></div>\n<h2>Updated Google Play requirements</h2>\n<p>Although I finally was able to fix my CI build pipeline and build rlease APK, the fight wasn’t over yet. Since August 2021 Google Play bumped the requirement for published apps to target Androdi SDK 31. It also now only accepts app bundles (.aab) instead of APKs.\nThis is a smaller issue but yet another hurdle I need overcome in order to publish an update to Google Play.</p>\n<h2>Conclusion</h2>\n<p>I was not ready to spend that much time trying to make a new app release and it was a bit of a challenge. I did not expect that just after a few months of not working with the project, I would have to go through all this just to make things work. I was going to make this feature available for testing just with one weekend, but ended up working following weekdays’ evenings.</p>\n<p>Many of these problems could have been avoided. All breaking changes to the APIs of the tools that we use do not happen overnight – they uaually are announced months and sometimes even years. These announcement should not be ignored, and actions should not be put off untill last minute.</p>\n<p>Everything works now, so not all is bad. Plus, this little experience with scripts I had was quite educational. I was so empowered by it, that on the same evening, I was also able to automate the deployment of this blog to Github Pages.</p>","fields":{"readingTime":{"text":"6 min read"}},"frontmatter":{"title":"Upgraded my project to Android gradle plugin 7","date":"September 25, 2021","updated":"September 25, 2021","description":"How upgrading to latest Android Gradle Plugin (7.x) broke my project build pipe line and what I did to fix it.","draft":false}},"previous":null,"next":{"fields":{"slug":"/creating-blog/"},"frontmatter":{"title":"Publishing Gatsby blog. Part 1."}}},"pageContext":{"id":"3d4de3dc-9dc4-5a81-a6fb-f33428fd18ab","nextPostId":"a3f0be7f-7426-5018-a202-49bc736289d8"}},
    "staticQueryHashes": ["2841359383","3274528899"]}