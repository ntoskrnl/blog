<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Anton Danshin's Blog]]></title><description><![CDATA[Blog about day-to-day "struggles" of a software developer. ]]></description><link>https://ntoskrnl.github.io</link><generator>GatsbyJS</generator><lastBuildDate>Sun, 17 Oct 2021 23:52:32 GMT</lastBuildDate><item><title><![CDATA[How to draw avatar placeholder in Jetpack Compose]]></title><description><![CDATA[When you want to display different users in your app, it is a good idea to provide an image. For example, when scrolling through the list…]]></description><link>https://ntoskrnl.github.io/blog/compose-user-avatar-placeholder</link><guid isPermaLink="false">https://ntoskrnl.github.io/blog/compose-user-avatar-placeholder</guid><pubDate>Sun, 17 Oct 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;When you want to display different users in your app, it is a good idea to provide an image. For example, when scrolling through the list some people would mostly pay attention to the text, but some will look at images. That’s why a lot of apps that contain list of people, (e.g. a Contacts app), always provide an avatar.&lt;/p&gt;
&lt;p&gt;Not all users might have avatars. If avatar is missing, it is often replaced with a placeholder. I find that the best placeholder should contain user initials and have different color per user. This way it is easier to identify different people in the list just by looking at the avatar placeholder.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7f63bef6c3b81bb0107600e4a734c676/d1882/material-letter-icons.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 19.62025316455696%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/0lEQVQI1wH0AAv/AOL49ZTk2d/39P///6bsxLXuzf///9Tb/665/vb6///z8e2Wl/bLy//////UtP/MqP///PPe/9uU/vXj/wBDz7wAv6RG0MKR57YFyFYS0Fui29FVZ/8gQfqBnv/yc2nVCAncMjf6t5j/fRb/dQz9vZe8QP+rAfzCR/8AO825AL+kPc6/gOOsBshXDc9YktTKTmD/JEX5dZP/8GVb1AgJ2igt+ayJ/3cM/3EF/LOMuDP/qgD8vTn/ANP073bcztDz7/3//IrlsZvpvP///8bO/5in/u70///q5+h5evO5uf/////Emf+8jf//+O7O/9J3/vHU/6YAq+QqAuEOAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Material letter icons as avatar placeholders&quot;
        title=&quot;Material letter icons as avatar placeholders&quot;
        src=&quot;/static/7f63bef6c3b81bb0107600e4a734c676/f058b/material-letter-icons.png&quot;
        srcset=&quot;/static/7f63bef6c3b81bb0107600e4a734c676/c26ae/material-letter-icons.png 158w,
/static/7f63bef6c3b81bb0107600e4a734c676/6bdcf/material-letter-icons.png 315w,
/static/7f63bef6c3b81bb0107600e4a734c676/f058b/material-letter-icons.png 630w,
/static/7f63bef6c3b81bb0107600e4a734c676/40601/material-letter-icons.png 945w,
/static/7f63bef6c3b81bb0107600e4a734c676/78612/material-letter-icons.png 1260w,
/static/7f63bef6c3b81bb0107600e4a734c676/d1882/material-letter-icons.png 1562w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;In this article we will look into how we can draw such an avatar placeholder in Jetpack Compose.&lt;/p&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;Just list a few requirements to our avatar placeholder:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It should display initials of the user on a circle with some background color.&lt;/li&gt;
&lt;li&gt;Text must always be legible (good contrast ratio), e.g. black text on a brown background is no good.&lt;/li&gt;
&lt;li&gt;If two users have same initials, color should be different.&lt;/li&gt;
&lt;li&gt;For the same user it should use the same background color.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Implementation&lt;/h2&gt;
&lt;p&gt;Input: user ID and full name.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Convert user data to color using HSV color space.&lt;/li&gt;
&lt;li&gt;Draw circle.&lt;/li&gt;
&lt;li&gt;Draw Initials.&lt;/li&gt;
&lt;li&gt;Put it all together.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Generating color by user name&lt;/h3&gt;
&lt;p&gt;In our code we are used to represent color as an 32-bit integer (ARGB format). What if we use a hashcode of user name as color? This might work but we often end up with having colors that are too dark, too light or even too transparent.&lt;/p&gt;
&lt;p&gt;Ideally, we want our color to have a fixed brightness – different users would have different color of the same brightness and saturation levels. Lucky for us there are color encodings that split the color into exactly these components.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;HSL&lt;/strong&gt; (for hue, saturation, lightness) and &lt;strong&gt;HSV&lt;/strong&gt; (for hue, saturation, value; also known as &lt;strong&gt;HSB&lt;/strong&gt;, for hue, saturation, brightness) are alternative representations of the &lt;strong&gt;RGB&lt;/strong&gt; color model, designed in the 1970s by computer graphics researchers to more closely align with the way human vision perceives color-making attributes. In these models, colors of each hue are arranged in a radial slice, around a central axis of neutral colors which ranges from black at the bottom to white at the top. — &lt;a href=&quot;https://en.wikipedia.org/wiki/HSL_and_HSV&quot;&gt;Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We can use HSL color space and fix saturation and lightness. In my app I found that &lt;code class=&quot;language-text&quot;&gt;lightness = 0.4f&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;saturation = 0.5f&lt;/code&gt; work the best.&lt;/p&gt;
&lt;p&gt;Here is how we can convert a &lt;code class=&quot;language-text&quot;&gt;String&lt;/code&gt; into a color in Android using &lt;code class=&quot;language-text&quot;&gt;HSL&lt;/code&gt; color space:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@ColorInt&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toHslColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    saturation&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Float &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.5f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    lightness&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Float &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0.4f&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Int &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; hashCode &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;fold&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; acc&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; char &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; char&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;code &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; acc &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;37&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; hue &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hue &lt;span class=&quot;token operator&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;360&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;absoluteValue&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toFloat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; ColorUtils&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;HSLToColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;floatArrayOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hue&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; saturation&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lightness&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can then generate a color by user name:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// generate full name string&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;listOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;firstName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lastName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;joinToString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;separator &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uppercase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; color &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toHslColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The only problem here is that users that share the same name will be given the same color. This can be fixed by adding user ID into the mix.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; color &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token interpolation variable&quot;&gt;$id&lt;/span&gt; / &lt;span class=&quot;token interpolation variable&quot;&gt;$name&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toHslColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Drawing background circle&lt;/h3&gt;
&lt;p&gt;Now we can simply draw a circle for a given user full name on &lt;code class=&quot;language-text&quot;&gt;Canvas&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token function&quot;&gt;Canvas&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;modifier &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Modifier&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fillMaxSize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;drawCircle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;SolidColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;color&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Draw initials&lt;/h3&gt;
&lt;p&gt;To draw initials on top of our background, we need to wrap everithing inside a &lt;code class=&quot;language-text&quot;&gt;Box&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token function&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;contentAlignment &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Alignment&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Center&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;// ...&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; initials &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;firstName&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lastName&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uppercase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; initials&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Putting it all together&lt;/h3&gt;
&lt;p&gt;When creating a component it would be a good idea to provide some basic customization. In my implementation I only need to have different size and text style.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Composable&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;UserHead&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    id&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    firstName&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    lastName&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    modifier&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Modifier &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Modifier&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    size&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Dp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;dp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    textStyle&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; TextStyle &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; MaterialTheme&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;typography&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;subtitle1&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Box&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;modifier&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;size&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;size&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; contentAlignment &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Alignment&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Center&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;listOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;firstName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; lastName&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;joinToString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;separator &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uppercase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; color &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Color&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token interpolation variable&quot;&gt;$id&lt;/span&gt; / &lt;span class=&quot;token interpolation variable&quot;&gt;$name&lt;/span&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toHslColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; initials &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;firstName&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lastName&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;take&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uppercase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            painter &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ColorPainter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;color&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            modifier &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Modifier&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;clip&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CircleShape&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            contentDescription &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Avatar&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Canvas&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;modifier &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Modifier&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;fillMaxSize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;drawCircle&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;SolidColor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;color&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;Text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;text &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; initials&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; style &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; textStyle&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; color &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Color&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;White&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here is how the component is rendered:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 428px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/41bfed567aabfc18eae15a48c53ef39c/47730/circle-avatar-placeholder.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABjklEQVQoz52Sy27aQBSGeYnAwilZgBmPZ4aZAVpRxTI3g4MByeGiVoIWRXmDSFlk0UdpniGrqIu821/NcZwoWUVZfDq/zpzzz+1UarUa6qenqHsexTOvgHKfoFKtVuE3m1BSQgiBpixwWpZI+QbxnFPv8q62Uj05AWcMptOBNQY/lcYPpUlra6G1LpqVejGy1lIMRbExrUkJY0xhGDAGaQ1uwzYeWBsPXONGajApcJGmOB6P2Gw22O12WK1WuMxz7Pd7bLdbHA4Hwq33er3CsMUYvmmNe9nB068rPP2+xl/ZgVEK8WCARZYhSRIsl0uMx2PEcUzGWZZRnE6nmM/nr4buhMoY/JEGj93v+NePcSc0uFKYJgnt7sxck2t2RrPZDHmeY7FYYL1eo9vt0tXfvOFXY3AlFI6hQs9atI1Bv9/HaDSiUw2HQ0RRRPo8ijCZTEinaUp17r3pl5uNBkQYIuAcjTAkOOcIOUcQBGCt1gvuNmVs+T5p3/epztVXyjn84uaQZtAjnC5n88N4Hv4DLbocTuFez+YAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Avatar placeholder with initials and color background example&quot;
        title=&quot;Avatar placeholder with initials and color background example&quot;
        src=&quot;/static/41bfed567aabfc18eae15a48c53ef39c/47730/circle-avatar-placeholder.png&quot;
        srcset=&quot;/static/41bfed567aabfc18eae15a48c53ef39c/c26ae/circle-avatar-placeholder.png 158w,
/static/41bfed567aabfc18eae15a48c53ef39c/6bdcf/circle-avatar-placeholder.png 315w,
/static/41bfed567aabfc18eae15a48c53ef39c/47730/circle-avatar-placeholder.png 428w&quot;
        sizes=&quot;(max-width: 428px) 100vw, 428px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;With just 20 lines of code we have created a simple Jetpack Compose component to display colorful placeholder for avatars with user initials. The full code can be found &lt;a href=&quot;https://gist.github.com/ntoskrnl/14622d88cad3387d14786aa259e4653f&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Countdown timer with Jetpack Compose]]></title><description><![CDATA[In my app I need to display some sort of timers and clocks in several places, so I thought it would be nice to make a stateful component for…]]></description><link>https://ntoskrnl.github.io/blog/compose-timer-implementation</link><guid isPermaLink="false">https://ntoskrnl.github.io/blog/compose-timer-implementation</guid><pubDate>Tue, 28 Sep 2021 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;In my app I need to display some sort of timers and clocks in several places, so I thought it would be nice to make a stateful component for it. I looked online and found several good and bad implementations of it. So I decided to share my views and how I would go about this problem.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/3acf0/countdown-timer.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAgX/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/aAAwDAQACEAMQAAABfJ3Fl0Gij//EABwQAAAGAwAAAAAAAAAAAAAAAAABAgQRMQMSE//aAAgBAQABBQJyebrLkInVdgq//8QAFREBAQAAAAAAAAAAAAAAAAAAEBL/2gAIAQMBAT8Bo//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAIBBQAAAAAAAAAAAAAAAAARASAiMUJh/9oACAEBAAY/ArGuGxDzR//EABoQAAIDAQEAAAAAAAAAAAAAAAABETFRcSH/2gAIAQEAAT8hVy/JE2eM4cpLBFB//9oADAMBAAIAAwAAABD/AP8A/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAERITH/2gAIAQMBAT8QUZB9P//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAECAQE/EIf/xAAbEAACAwEBAQAAAAAAAAAAAAABEQAhMaFhwf/aAAgBAQABPxAic0ogNW7lQEWaU/ZrQbT1XOKbnAJ//9k=&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Countdown timer&quot;
        title=&quot;Countdown timer&quot;
        src=&quot;/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/828fb/countdown-timer.jpg&quot;
        srcset=&quot;/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/ff44c/countdown-timer.jpg 158w,
/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/a6688/countdown-timer.jpg 315w,
/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/828fb/countdown-timer.jpg 630w,
/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/0ede0/countdown-timer.jpg 945w,
/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/3ac88/countdown-timer.jpg 1260w,
/static/0bfe4fbd4ef1f0920b486881f6c2f6d5/3acf0/countdown-timer.jpg 2000w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;small&gt; — Design vector created by pikisuperstar &lt;a href=&quot;https://www.freepik.com/vectors/design&quot;&gt;www.freepik.com&lt;/a&gt;&lt;/small&gt;&lt;/p&gt;
&lt;h2&gt;The problem&lt;/h2&gt;
&lt;p&gt;Let’s set our goal first. We want to implement a component that allows you to display a countdown timer.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;There shouldn’t be any assumption on how it will be displayed: it can be a &lt;code class=&quot;language-text&quot;&gt;Text()&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Canvas()&lt;/code&gt; or anything.&lt;/li&gt;
&lt;li&gt;The first displayed state should be initial state&lt;/li&gt;
&lt;li&gt;The last displayed state must be 0 (never negative).&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Simple solution – Naive approach&lt;/h2&gt;
&lt;p&gt;To achieve that, we can create a &lt;code class=&quot;language-text&quot;&gt;MutableState&amp;lt;Long&gt;&lt;/code&gt; that would update itself in a &lt;code class=&quot;language-text&quot;&gt;LaunchedEffect&lt;/code&gt;. The users will just need to render it and the UI will automatically be updated on change.&lt;/p&gt;
&lt;p&gt;Here is how it can be used:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber 0&quot; class=&quot;language-kotlin line-numbers&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Composable&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;MyTimer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; timeLeftMs &lt;span class=&quot;token keyword&quot;&gt;by&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rememberCountdownTimerState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5_000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;Text&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;span class=&quot;token interpolation variable&quot;&gt;$timeLeftMs&lt;/span&gt; ms left&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A simple implementation would look like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber 0&quot; class=&quot;language-kotlin line-numbers&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Composable&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rememberCountdownTimerState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    initialMillis&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    step&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; MutableState&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Long&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; timeLeft &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; remember &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;mutableStateOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;LaunchedEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;isActive &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtLeast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; timeLeft
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It will work, but it has several obvious problems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The last delay could be longer than actually needed, so &lt;code class=&quot;language-text&quot;&gt;0&lt;/code&gt; state will be rendered with up to 99 ms delay.&lt;/li&gt;
&lt;li&gt;There is not account of time that took to execute &lt;code class=&quot;language-text&quot;&gt;onTick()&lt;/code&gt;, and there is no guarantee that &lt;code class=&quot;language-text&quot;&gt;delay(n)&lt;/code&gt; will return resume after exactly &lt;code class=&quot;language-text&quot;&gt;n&lt;/code&gt; ms.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The first problem can be quickly fixed by making sure we never &lt;code class=&quot;language-text&quot;&gt;delay&lt;/code&gt; by more than &lt;code class=&quot;language-text&quot;&gt;timeLeft&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber 0&quot; class=&quot;language-kotlin line-numbers&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Composable&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rememberCountdownTimerState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    initialMillis&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    step&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; MutableState&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Long&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; timeLeft &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; remember &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mutableStateOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;LaunchedEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;isActive &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtLeast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtMost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; timeLeft
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To fix second problem we need to use system clock.&lt;/p&gt;
&lt;h2&gt;Better solution – Using SystemClock&lt;/h2&gt;
&lt;p&gt;Instead of &lt;code class=&quot;language-text&quot;&gt;System.currentTimeMillis()&lt;/code&gt; available in Java, for this particular task it is recommented to use some monotonic time source, such as Android &lt;code class=&quot;language-text&quot;&gt;SystemClock.uptimeMillis()&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The idea is to remember when we started our timer in &lt;code class=&quot;language-text&quot;&gt;startTime&lt;/code&gt; and on each cycle of the loop check how much time has actually passed (&lt;code class=&quot;language-text&quot;&gt;duration&lt;/code&gt;).&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber 0&quot; class=&quot;language-kotlin line-numbers&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Composable&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rememberCountdownTimerState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    initialMillis&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    step&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; MutableState&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Long&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; timeLeft &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; remember &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mutableStateOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;LaunchedEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; startTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; SystemClock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uptimeMillis&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;isActive &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// how much time actually passed&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; duration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SystemClock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;uptimeMillis&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; startTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtLeast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtLeast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtMost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; timeLeft
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The solution solution works perfectly fine, but if we were to publish it as a library and let other people use it, we would probably want to add some tests to it (e.g. screenshot tests). To make it testable we can pass a lambda as our time source, which would default to &lt;code class=&quot;language-text&quot;&gt;SystemClock.uptimeMillis()&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;Alternative solution – Using withFrameMillis&lt;/h2&gt;
&lt;p&gt;If we dig into how animated components are tested, we can find that compose has its own built-in monotonic time source – &lt;code class=&quot;language-text&quot;&gt;MonotonicFrameClock&lt;/code&gt;. It is an abstraction over Choreographer, if we provide another implementation in unit-tests, it will allow to control time there.&lt;/p&gt;
&lt;p&gt;Here is how we can rewrite our component to use this &lt;code class=&quot;language-text&quot;&gt;withFrameMillis()&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre style=&quot;counter-reset: linenumber 0&quot; class=&quot;language-kotlin line-numbers&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;&lt;span class=&quot;token annotation builtin&quot;&gt;@Composable&lt;/span&gt;
&lt;span class=&quot;token annotation builtin&quot;&gt;@OptIn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ExperimentalComposeApi&lt;span class=&quot;token operator&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;rememberCountdownTimerState&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
    initialMillis&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    step&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Long &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1000&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; MutableState&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Long&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; timeLeft &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; remember &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;mutableStateOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;LaunchedEffect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; step&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; startTime &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; withFrameMillis &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; it &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;isActive &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; duration &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; withFrameMillis &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; time &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; startTime&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtLeast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;initialMillis &lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt; duration&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtLeast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;step&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;coerceAtMost&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timeLeft&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; timeLeft
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;span aria-hidden=&quot;true&quot; class=&quot;line-numbers-rows&quot; style=&quot;white-space: normal; width: auto; left: 0;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The advantage of this implementation is that it can be tested using &lt;code class=&quot;language-text&quot;&gt;ComposeTestRule&lt;/code&gt; just like other components with animations.
Hovever, I also see several issues with this approach:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The timer is tied to the display refresh rate, which means no mater how small we set the step, the loop will suspend on each frame (this could be a good thing). However, for that reason, the timer will probably be less presize.&lt;/li&gt;
&lt;li&gt;It probably introduces more overhead due to abstractions and callback (compared to system call to &lt;code class=&quot;language-text&quot;&gt;SystemClock.uptimeMillis()&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;It would probably be an overkill to write a timer this way, but inspite of all this, I still had a lot of fun digging into it.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;We’ve looked into several implementations of a countdown timer in Jetpack Compose. I am sure there are more and we just scratched the surface. I would personally use the approach with &lt;code class=&quot;language-text&quot;&gt;SystemClock.uptimeMillis()&lt;/code&gt;, but I think that &lt;code class=&quot;language-text&quot;&gt;withFrameMillis()&lt;/code&gt; isn’t such a bad idea either. Let me know what you think. :)&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Upgraded my project to Android gradle plugin 7]]></title><description><![CDATA[I’ve spent several nights this week to get one of my project’s CI pipeline back up on its feet after upgrading to the latest Android gradle…]]></description><link>https://ntoskrnl.github.io/blog/updating-to-android-gradle-plugin-7</link><guid isPermaLink="false">https://ntoskrnl.github.io/blog/updating-to-android-gradle-plugin-7</guid><pubDate>Sat, 25 Sep 2021 15:00:00 GMT</pubDate><content:encoded>&lt;p&gt;I’ve spent several nights this week to get one of my project’s CI pipeline back up on its feet after upgrading to the latest Android gradle plugin (7.0.2). I usually try to keep versions of tools and lbraries up-to-date, but after haven’t got time to work on the project and couldn’t keep up. As a result, the app was not updated for the last 4 months – the time when Google suddenly released a bunch of updates to Android’s build tools, which broke everything…&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;It has never been like this and now it is exactly the same again.&lt;/strong&gt; — Viktor Chernomyrdin&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;Breaking changes in Gradle 7.x&lt;/h2&gt;
&lt;p&gt;Android Gradle Plugin now shares the same major version number with Gradle, so its version jumped from 4.x to 7.0. This is a good thing, as there will be less confusion with the versions. But this version bump comes with some changes. In addition to breaking changes to the plugin APIs, which forced me to update several other third-party gradle plugins (e.g. Sentry), Android Gradle Plugin adds some requirements to the environment.&lt;/p&gt;
&lt;h3&gt;Updating to JDK 11&lt;/h3&gt;
&lt;p&gt;Previously, everything would compile with JDK 8. Now Android Gradle Plugin requires JDK 11.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;An exception occurred applying plugin request [id: &apos;com.android.application&apos;]
&gt; Failed to apply plugin &apos;com.android.internal.application&apos;.
   &gt; Android Gradle plugin requires Java 11 to run. You are currently using Java 1.8.
     You can try some of the following options:
       - changing the IDE settings.
       - changing the JAVA_HOME environment variable.
       - changing `org.gradle.java.home` in `gradle.properties`.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;On MacOS tt can be installed with &lt;code class=&quot;language-text&quot;&gt;Homebrew&lt;/code&gt; with the following command: &lt;code class=&quot;language-text&quot;&gt;brew install --cask adoptopenjdk11&lt;/code&gt;. There is also a nice article on how to enable quick &lt;a href=&quot;https://mkyong.com/java/how-to-set-java_home-environment-variable-on-mac-os-x/#switch-between-different-jdk-versions&quot;&gt;switching between JDK versions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I thought this was it, so I moved on with the development of my feature. Later, when I was ready to present an early prototype for testing, I found out that our CI server was unable to build the app. All because CI was trying to build it with JDK 8. Luckily, we run our Android builds inside a docker container. And I thought to myself:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This where docker will show it’s power!
All I need to do is to replace package &lt;code class=&quot;language-text&quot;&gt;openjdk-8-jdk&lt;/code&gt; with &lt;code class=&quot;language-text&quot;&gt;openjdk-11-jdk&lt;/code&gt; in my Dockerfile, and everything should work, just like on my local machine.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Build failed again when running Android &lt;code class=&quot;language-text&quot;&gt;sdkmanager&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Step 13/18 : RUN yes | sdkmanager --licenses
Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: javax/xml/bind/annotation/XmlSchema
   at com.android.repository.api.SchemaModule$SchemaModuleVersion.&amp;lt;init&gt;(SchemaModule.java:156)
   at com.android.repository.api.SchemaModule.&amp;lt;init&gt;(SchemaModule.java:75)
    at com.android.sdklib.repository.AndroidSdkHandler.&amp;lt;clinit&gt;(AndroidSdkHandler.java:81)
    at com.android.sdklib.tool.sdkmanager.SdkManagerCli.main(SdkManagerCli.java:73)
    at com.android.sdklib.tool.sdkmanager.SdkManagerCli.main(SdkManagerCli.java:48)
Caused by: java.lang.ClassNotFoundException: javax.xml.bind.annotation.XmlSchema
    at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:581)
   at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:178)
    at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:522)
    ... 5 more
The command &apos;/bin/sh -c yes | sdkmanager --licenses&apos; returned a non-zero code: 1&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It looks like when I put together this build script more than a year ago, I probably used some outdated sources of information. It used &lt;a href=&quot;https://developer.android.com/studio/releases/sdk-tools&quot;&gt;deprecated SDK tools&lt;/a&gt;, which apparently doesn’t work with Java 11 and haven’t been updated for a long time. I’ve spent quite some time trying to make it work before I realized that this was the dead end and I had to move on to the new Android &lt;a href=&quot;https://developer.android.com/studio#cmdline-tools&quot;&gt;command-line tools&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;My new Dockerfile with Android build environment for CI now looks like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;dockerfile&quot;&gt;&lt;pre class=&quot;language-dockerfile&quot;&gt;&lt;code class=&quot;language-dockerfile&quot;&gt;&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;FROM&lt;/span&gt; ubuntu:18.04&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; LANG=&lt;span class=&quot;token string&quot;&gt;&apos;C&apos;&lt;/span&gt; LANGUAGE=&lt;span class=&quot;token string&quot;&gt;&apos;en&apos;&lt;/span&gt; LC_ALL=&lt;span class=&quot;token string&quot;&gt;&apos;C&apos;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; DEBIAN_FRONTEND=noninteractive&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; GRADLE_HOME=/usr/bin/gradle&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; ANDROID_SDK_ROOT=/opt/android-sdk&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; apt-get update &amp;amp;&amp;amp; apt-get install -y &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        --allow-downgrades --allow-remove-essential --allow-change-held-packages &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        expect &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        git &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        mc &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        gradle &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        unzip &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        wget curl &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        libc6-i386 lib32stdc++6 lib32gcc1 lib32ncurses5 lib32z1 &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        openjdk-11-jdk &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; rm -f /etc/ssl/certs/java/cacerts; &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    /var/lib/dpkg/info/ca-certificates-java.postinst configure&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; PATH &lt;span class=&quot;token variable&quot;&gt;$PATH&lt;/span&gt;:/opt/tools&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; cd /opt &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; wget --output-document=android-commandline-tools.zip &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
        https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; mkdir -p &lt;span class=&quot;token variable&quot;&gt;${ANDROID_SDK_ROOT}&lt;/span&gt;/cmdline-tools &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; unzip android-commandline-tools.zip -d &lt;span class=&quot;token variable&quot;&gt;${ANDROID_SDK_ROOT}&lt;/span&gt;/cmdline-tools &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; mv &lt;span class=&quot;token variable&quot;&gt;${ANDROID_SDK_ROOT}&lt;/span&gt;/cmdline-tools/cmdline-tools &lt;span class=&quot;token variable&quot;&gt;${ANDROID_SDK_ROOT}&lt;/span&gt;/cmdline-tools/latest &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; rm -v android-commandline-tools.zip &lt;span class=&quot;token operator&quot;&gt;\&lt;/span&gt;
    &amp;amp;&amp;amp; chown -R root.root /opt/android-sdk&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; ANDROID_HOME &lt;span class=&quot;token string&quot;&gt;&quot;${ANDROID_SDK_ROOT}&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; JAVA_HOME  /usr/lib/jvm/java-11-openjdk-amd64&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; PATH &lt;span class=&quot;token variable&quot;&gt;$PATH&lt;/span&gt;:&lt;span class=&quot;token variable&quot;&gt;$JAVA_HOME&lt;/span&gt;/bin:&lt;span class=&quot;token variable&quot;&gt;$ANDROID_HOME&lt;/span&gt;/cmdline-tools/latest/bin&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; yes | sdkmanager --licenses&lt;/span&gt;
&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; sdkmanager --update&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ADD&lt;/span&gt; packages.txt &lt;span class=&quot;token variable&quot;&gt;$ANDROID_SDK_ROOT&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;RUN&lt;/span&gt; yes | sdkmanager --package_file=&lt;span class=&quot;token variable&quot;&gt;$ANDROID_SDK_ROOT&lt;/span&gt;/packages.txt&lt;/span&gt;

&lt;span class=&quot;token instruction&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;ENV&lt;/span&gt; PATH &lt;span class=&quot;token variable&quot;&gt;$PATH&lt;/span&gt;:&lt;span class=&quot;token variable&quot;&gt;$ANDROID_HOME&lt;/span&gt;/tools:&lt;span class=&quot;token variable&quot;&gt;$ANDROID_HOME&lt;/span&gt;/tools/bin:&lt;span class=&quot;token variable&quot;&gt;$ANDROID_HOME&lt;/span&gt;/platform-tools&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Broken release build&lt;/h3&gt;
&lt;p&gt;So, I finally had an environment on my CI that can build my app. But when it tried to make a release apk, it failed again.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; &quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/07db1087d81e271fbdf20d5a7de3b3f8/1cb21/broken-ci-build.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 34.810126582278485%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABdElEQVQozyWPiarbMBBF/f9f9iAQKG2TZvMuW5JlW5YUL2meT4k6MMxwN2aS7/ebfd/51LZtCCHwweO95/l8Yu0Y8XVdcd7FfZ5nxnHEOUfwHmstIQRC8CSfoO99573vzPNCnuX0pke2CtMZ6qomuMBkHUpqJjsxmIG2aVFdhzYG0bRR2+mOZCpyrGxZjcGNHWKsUU7Szx1qammGGhM07SRJZR45OUkaU+HqCptnjFlK7xT905CMf06Y+4WtLJh0SREymrlCbgIxl5Q+Q21NxNL+FqdYKqrxwfL7B8vxQDge0K5AbZKkPZ9oLifs/Yqqblz0ORqLKeVhrlzVmdw+SPs75+YX2XAnHe7c2hP255Hx8EV3+KLUF0pXkEgz0JuO17LhFxsvkrNAvyTtXFP5Ar21yEWQD4/IffDa5WhboMaMxjxQi6BbFUnTjdjJ8nq98aujCjlyaTBv9d8Yihiu1obqE7K1sT+vm7dGvSRiqaO+/9vxDzBYDOI4Xk9JAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Broken release apk build on CI&quot;
        title=&quot;Broken release apk build on CI&quot;
        src=&quot;/static/07db1087d81e271fbdf20d5a7de3b3f8/f058b/broken-ci-build.png&quot;
        srcset=&quot;/static/07db1087d81e271fbdf20d5a7de3b3f8/c26ae/broken-ci-build.png 158w,
/static/07db1087d81e271fbdf20d5a7de3b3f8/6bdcf/broken-ci-build.png 315w,
/static/07db1087d81e271fbdf20d5a7de3b3f8/f058b/broken-ci-build.png 630w,
/static/07db1087d81e271fbdf20d5a7de3b3f8/40601/broken-ci-build.png 945w,
/static/07db1087d81e271fbdf20d5a7de3b3f8/78612/broken-ci-build.png 1260w,
/static/07db1087d81e271fbdf20d5a7de3b3f8/1cb21/broken-ci-build.png 2586w&quot;
        sizes=&quot;(max-width: 630px) 100vw, 630px&quot;
        style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;&quot;
        loading=&quot;lazy&quot;
        decoding=&quot;async&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The error now was in Sentry gradle plugin:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;&gt; Task :app:addSentryProguardSettingsForRelease FAILED

FAILURE: Build failed with an exception.

* What went wrong:
A problem was found with the configuration of task &apos;:app:addSentryProguardSettingsForRelease&apos; (type &apos;SentryProguardConfigTask&apos;).
  - Type &apos;io.sentry.android.gradle.SentryProguardConfigTask&apos; property &apos;applicationVariant&apos; is missing an input or output annotation.

    Reason: A property without annotation isn&apos;t considered during up-to-date checking.

    Possible solutions:
      1. Add an input or output annotation.
      2. Mark it as @Internal.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Apparentrly, during last few months technologies made a big step forward. Gradle has removed some deprecated plugin API, used by older version of Sentry plugin. Sentry also released a bunch of updates that I missed.&lt;/p&gt;
&lt;p&gt;The annoying par was that the error only showed itself during compilation of &lt;code class=&quot;language-text&quot;&gt;release&lt;/code&gt; type. Lint also didn’t alarm me about presence of a more recent version of the plugin. Anyway, updating &lt;code class=&quot;language-text&quot;&gt;sentry-android-gradle-plugin&lt;/code&gt; from 1.7.36 to latest 2.1.4 fixed the problems.&lt;/p&gt;
&lt;h2&gt;Fixing R8 full mode&lt;/h2&gt;
&lt;p&gt;After updating CI environment, I finally was able to build a proper release APK. However, when I run the app, it just crashed.&lt;/p&gt;
&lt;p&gt;There was a problem with R8 full mode, which appeared after update. Deobfuscated stacktrace looked like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Caused by java.lang.ClassCastException: java.lang.Class cannot be cast to java.lang.reflect.ParameterizedType
    at retrofit2.HttpServiceMethod.parseAnnotations(HttpServiceMethod.java:46)
    at retrofit2.ServiceMethod.parseAnnotations(ServiceMethod.java:39)
    at retrofit2.Retrofit.loadServiceMethod(Retrofit.java:202)
    at retrofit2.Retrofit.validateServiceInterface(Retrofit.java:189)
    at retrofit2.Retrofit.create(Retrofit.java:141)
    ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The issue is not reproduced with &lt;code class=&quot;language-text&quot;&gt;android.enableR8.fullMode=false&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I almost decided to disable R8 full mode but suddenly I found a question with &lt;a href=&quot;https://stackoverflow.com/q/69098376/1199452&quot;&gt;similar problem&lt;/a&gt; on StackOverflow. The answer had a bunch of ProGuard rules that work, but actually redundant.&lt;/p&gt;
&lt;p&gt;It looks like in R8 full mode, generic type of an implicit parameter &lt;code class=&quot;language-text&quot;&gt;kotlin.coroutines.Continuation&amp;lt;T&gt;&lt;/code&gt; in &lt;code class=&quot;language-text&quot;&gt;suspend&lt;/code&gt; functions gets erased. That’s why adding the following line to &lt;code class=&quot;language-text&quot;&gt;proguard-rules.pro&lt;/code&gt; solves the above error:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;-keep,allowobfuscation,allowshrinking class kotlin.coroutines.Continuation&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Updated Google Play requirements&lt;/h2&gt;
&lt;p&gt;Although I finally was able to fix my CI build pipeline and build rlease APK, the fight wasn’t over yet. Since August 2021, Google Play bumped the requirement for published apps to target Androdi SDK 31. It also now only accepts app bundles (.aab) rather than APKs.
This is a smaller issue but yet another hurdle I need overcome in order to publish an update to Google Play.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I was not ready to spend that much time trying to make a new app release and it was a bit of a challenge. I did not expect that just after a few months of not working with the project, I would have to go through all this. I was planning to spend just one weekend to make this feature available for testing, but ended up working the evenings of the following week.&lt;/p&gt;
&lt;p&gt;Many of these problems could have been avoided. All breaking changes in the APIs of the tools and libraries that we use do not happen overnight – they are uaually announced months and sometimes even years in advance. These announcement should not be ignored, and actions should not be put off till the last minute.&lt;/p&gt;
&lt;p&gt;Everything works now, so not all is bad. Plus, this little experience with scripts I had was quite educational and inspiring. On the same evening that I fixed my CI build, I was also able to automate the deployment of this blog to Github Pages.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Publishing Gatsby blog. Part 1.]]></title><description><![CDATA[As promised in my first blog post, I am sharing how I set up Gatsby blog and deployed it to Github Pages.
There is a lot of material on the…]]></description><link>https://ntoskrnl.github.io/blog/creating-blog</link><guid isPermaLink="false">https://ntoskrnl.github.io/blog/creating-blog</guid><pubDate>Wed, 22 Sep 2021 22:30:00 GMT</pubDate><content:encoded>&lt;p&gt;As promised in my first blog post, I am sharing how I set up Gatsby blog and deployed it to Github Pages.
There is a lot of material on the Internet on this particular topic, but I still want to document my experience in case I need to do it again.&lt;/p&gt;
&lt;p&gt;I split this into two posts. Here is what we’ll cover in this one:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;How to install Node.js and Gatsby on MacOS.&lt;/li&gt;
&lt;li&gt;How to create blog from blog-starter template.&lt;/li&gt;
&lt;li&gt;Explain project structure and how it works.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Publishing to GitHub pages will be in the next post.&lt;/p&gt;
&lt;h2&gt;Istalling our tools&lt;/h2&gt;
&lt;p&gt;In order to build website with Gatsby.js, you need to install Node.js. Node is a JavaScript runtime build on Chrome’s javascript engine. Just like you need JRE to run Java apps, you also need some environment (like a web-browser) to run javascript programs. Node.js lets you run javascript without the browser. It also comes with a package manager, which gives you access to thousands of libraries and tools.&lt;/p&gt;
&lt;h3&gt;Installing Node.js&lt;/h3&gt;
&lt;p&gt;You may go ahead and install the latest stable Node version. But because there are many versions of Node (just like with Java), and different projects might require different versions of node, there is this tool called “nvm”, or Node Version Manager. Usually you would install this first, and then use it to install a desired version of Node. The advantage of using nvm is that you can have several versions of Node.js and switch between them with a command.&lt;/p&gt;
&lt;p&gt;To install LTS version of Node.js on MacOS run these two commands:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# installing VVM&lt;/span&gt;
brew &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; nvm
&lt;span class=&quot;token comment&quot;&gt;# installing LTS version of Node.js&lt;/span&gt;
nvm &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; --lts&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Run &lt;code class=&quot;language-text&quot;&gt;node --version&lt;/code&gt; to check the installed version.&lt;/p&gt;
&lt;h3&gt;Installing Gatsby CLI&lt;/h3&gt;
&lt;p&gt;Gatsby.js is not just a JS framework, it’s a toolkit that among other things includes development http server, web GraphQL IDE. To manage all this they ship a command line tool, aka &lt;a href=&quot;https://www.gatsbyjs.com/docs/reference/gatsby-cli/&quot;&gt;Gatsby CLI&lt;/a&gt;, which can be installed with &lt;code class=&quot;language-text&quot;&gt;npm&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# install Gatsby CLI globally&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; -g gatsby-cli&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Creating blog with Gatsby&lt;/h2&gt;
&lt;p&gt;You can create a new website with &lt;code class=&quot;language-text&quot;&gt;gatsby new&lt;/code&gt; and write initial boilerplate yourself, but CLI tools provide a convenient way to create a project from a variety of templates. I chose the simplest thing that is available out there, which is &lt;a href=&quot;https://www.gatsbyjs.com/starters/gatsbyjs/gatsby-starter-blog&quot;&gt;Gatsby Starter Blog&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;Creating website from template&lt;/h3&gt;
&lt;p&gt;Navigate to the directory where you want to create your project and run the following command (replace &lt;code class=&quot;language-text&quot;&gt;YOUR-PROJECT-NAME-HERE&lt;/code&gt; with the name of your project):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;npx gatsby new YOUR-PROJECT-NAME-HERE https://github.com/gatsbyjs/gatsby-starter-blog&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Gatsby will create a directory and set up a website based on provided template.&lt;/p&gt;
&lt;p&gt;You can run your website with &lt;code class=&quot;language-text&quot;&gt;gatsby develop&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;Project structure&lt;/h3&gt;
&lt;p&gt;Here is how my project structure looks like as of now:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;./
├── package.json
├── gatsby-browser.js
├── gatsby-config.js
├── gatsby-node.js
├── src
│   ├── components
│   │   ├── bio.js
│   │   ├── layout.js
│   │   └── seo.js
│   ├── images
│   │   ├── gatsby-icon.png
│   │   └── profile-pic.jpg
│   ├── normalize.css
│   ├── pages
│   │   ├── 404.js
│   │   ├── index.js
│   │   └── using-typescript.tsx
│   ├── style.css
│   └── templates
│       └── blog-post.js
├── content
│   └── blog
│       ├── creating-blog
│       │   └── index.md
│       └── hello-world
│           └── index.md
├── public
│   └──...
└── static
    └── ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;All these files and directories have the following functions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;package.json&lt;/code&gt; – is a file that list project build config and dependencies.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-config.js&lt;/code&gt; – main configuration file of gatsby site, contains plugin declaration and setup.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-browser.js&lt;/code&gt; – allows customization/extension of default Gatsby settings affecting the browser.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-node.js&lt;/code&gt; – the main module that will be run by Gatsby to build website’s pages.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;src&lt;/code&gt; – derectory with the website’s javascript code that will be run by Gatsby and &lt;code class=&quot;language-text&quot;&gt;gatsby-node.js&lt;/code&gt; to render pages.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;src/components&lt;/code&gt; – here we can put reusable react components.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;src/pages&lt;/code&gt; – code that will be used to render pages: each js file will generate it’s own page.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;src/teplates&lt;/code&gt; – similar to previous, but will be used for generating multiple pages (like blog posts).&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;content&lt;/code&gt; - contains directories with Markdown files that will be transformed into blog posts.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;public&lt;/code&gt; – output directory with generated website.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;How it works&lt;/h3&gt;
&lt;p&gt;This is what happens when you run &lt;code class=&quot;language-text&quot;&gt;gatsby develop&lt;/code&gt;:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Gatsby will run the code from &lt;code class=&quot;language-text&quot;&gt;gatsby-node.js&lt;/code&gt;, and applies plugins and config provided in &lt;code class=&quot;language-text&quot;&gt;gatsby-config.js&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;gatsby-browser.js&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Gatsby will generate index and 404 pages using code defined in &lt;code class=&quot;language-text&quot;&gt;src/pages&lt;/code&gt; directory. They will be rendered with &lt;code class=&quot;language-text&quot;&gt;Layout&lt;/code&gt; component defined in &lt;code class=&quot;language-text&quot;&gt;src/components/layout.js&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Pluging will be applied at different steps of the build process.
&lt;ul&gt;
&lt;li&gt;Particularly, plugin &lt;code class=&quot;language-text&quot;&gt;gatsby-transformer-remark&lt;/code&gt; will scan &lt;code class=&quot;language-text&quot;&gt;contents&lt;/code&gt; folder and transform all markdown into structured data, that can be retrieved with GraphQL API.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-plugin-feed&lt;/code&gt; will generate RSS feed.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;gatsby-node.js&lt;/code&gt; will query for all blog posts and generate pages for them during build time using &lt;code class=&quot;language-text&quot;&gt;src/templates/blog-post.js&lt;/code&gt; component.&lt;/li&gt;
&lt;li&gt;Generated content is placed into &lt;code class=&quot;language-text&quot;&gt;public&lt;/code&gt; folder and served by local HTTP server at &lt;code class=&quot;language-text&quot;&gt;http://localhost:8000/&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;Customizing your website&lt;/h3&gt;
&lt;p&gt;The main focus for me was to get rid of old content and figure out how everything works by tweaking some things. All I did is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Removed old content and replaced with my own (inluding site meta data).&lt;/li&gt;
&lt;li&gt;Fixed some CSS, e.g. fixed round avatar on Safari.&lt;/li&gt;
&lt;li&gt;Added 2 meta paramaters to blog posts: “updated” and “draft” and used them in pages.&lt;/li&gt;
&lt;li&gt;Added read time estimate (via plugin &lt;code class=&quot;language-text&quot;&gt;gatsby-remark-reading-time&lt;/code&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;My initial impression of the code and project in general was pretty poor. I have only been using strongly typed languages, and when I first saw the code in the project, I thought it was a mess. I thought it would take me a lot of time to figure things out and get the blog going. Turned out, I quickly picked up the main idea of how it works and now it is not as scarry as it initially seemed.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I’ve set up Node.js on my Mac, installed gatsby and created a simple blog. In my next post I will describe how I published the website to GitHub Pages and set up auto deployment.&lt;/p&gt;
&lt;p&gt;Thanks for reading.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[First blog post]]></title><description><![CDATA[I decided to teach myself some modern web technologies and put together a static blog based on Gatsby.js. Who am I? My name is Anton. I am a…]]></description><link>https://ntoskrnl.github.io/blog/hello-world</link><guid isPermaLink="false">https://ntoskrnl.github.io/blog/hello-world</guid><pubDate>Sat, 18 Sep 2021 17:00:00 GMT</pubDate><content:encoded>&lt;p&gt;I decided to teach myself some modern web technologies and put together a static blog based on Gatsby.js.&lt;/p&gt;
&lt;h3&gt;Who am I?&lt;/h3&gt;
&lt;p&gt;My name is Anton. I am a professional Android developer.
I am going to create a dedicated &lt;strong&gt;About&lt;/strong&gt; page with more information, but for now, I think this is enough.&lt;/p&gt;
&lt;h3&gt;What will I be blogging about?&lt;/h3&gt;
&lt;p&gt;I don’t know yet. I think I’ll be posting about my work. But I could also post about some other life stuff. If this thing doesn’t sink, I plan to add Portfolio and CV sections. We’ll see.&lt;/p&gt;
&lt;h3&gt;Why do I need a blog?&lt;/h3&gt;
&lt;p&gt;I had a WordPress blog more than six years ago but somehow abandoned it. Although it took quite a bit of effort to publish articles at times, I have to admit results were rather rewarding. I did enjoy sharing my knowledge, and based on comments I received from my old blog, it helped some people.&lt;/p&gt;
&lt;p&gt;Of course, there are other ways of sharing knowledge. But throughout my career as a software engineer, I realized that I don’t enjoy making presentations. I usually work on something that I cannot open source on Github. I don’t usually go on meet-ups, etc.&lt;/p&gt;
&lt;p&gt;Sharing knowledge is not the only reason why one would want to maintain a blog:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;If a blog focuses on professional matters, it complements the author’s resume. I think that having a blog did help me with landing my first full-time job at a good company.&lt;/li&gt;
&lt;li&gt;Blogs help to organize your thoughts and can also be the channel to express one’s emotions freely.&lt;/li&gt;
&lt;li&gt;To a non-native speaker of English, writing a blog in this language helps to train their writing skills. I remember I did start writing my blog in English for this very reason.&lt;/li&gt;
&lt;li&gt;And you can learn (or reinforce) a bunch of other stuff too. Like HTML/CSS, JavaScript, and some other technologies.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Why don’t I use a blogging platform?&lt;/h3&gt;
&lt;p&gt;I had experience with WordPress and I can’t complain – everything worked. I’ve also tried to publish a couple of articles on Medium – no problem with that as well. My main motivation for starting a self-hosted static blog is to learn some new things in modern web development.&lt;/p&gt;
&lt;p&gt;I realized that over the past 8 years since I did anything for the web, the technologies have made a huge step forward. There is a lot to catch up with and honestly, it’s a bit overwhelming. I will have to make myself not try to eat the whole thing and split the process into bite-sized pieces. So, what do I plan to learn with this new blog?&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;First of all, I will need to host this blog somewhere. I don’t really wanna have a personal domain or hosting server at this point. The first thing that comes to my mind is Github Pages. So, if you are reading this in 2021, this is probably where it is hosted.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;I will also have to dive into this static website development thing and Gatsby.js in particular. Right now, a lot is like magic to me. As I add features and improve the design, I will have to learn some javascript and CSS. So, this website will be my main playground.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Hopefully, I will be able to add content regularly, and because of that, I will need to automate the deployment process. In the beginning, it’s probably going to be just a simple bash script. Then I would need to wrap it into a docker image to make the scrip platform-independent and enable me to deploy the website with the click of a button on Github Actions.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I’ll be posting my journey through these steps in this blog. Stay tuned.&lt;/p&gt;</content:encoded></item></channel></rss>